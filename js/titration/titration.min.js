var acid="Choose",base="Choose",indicator="Choose";aliquot="Choose";var graph,graphCTX,liquids,liquidsCTX,stirBar,stirBarCTX,strongAcid,strongBase,titrant,startLevel,titreAtEqPt,buretReading,reading,titre,prevTitre,colour,darkerColour,pH,pHInd,pHReading,pHAtEqPt,prevpH,concAcid,concBase,pHDiff,prevpHDiff,Ka,Kb,titreInterval,stirCount,pipet=0,dropRate=70,level=0,titre=0,colourDpt=!1,eqPtFound=!1,Kw=1e-14,paleGrey="#f0f0f0",indRed1=255,indGreen1=255,indBlue1=255,indRed2=255,indGreen2=255,indBlue2=255,tapOpen=!1,liquidsAdded=!1,s="",errFlag="<font color='red'><b>*</b></font>",noErrFlag="",infinity="inf.";function getAcid(){clearInterval(titreInterval),acid=document.getElementById("acid").value,setAcidity(),document.getElementById("acidErr").innerHTML="酸",ready()}function getBase(){clearInterval(titreInterval),base=document.getElementById("base").value,setBasicity(),document.getElementById("baseErr").innerHTML="碱",ready()}function getIndicator(){clearInterval(titreInterval),setIndicator(indicator=document.getElementById("indicator").value),document.getElementById("indErr").innerHTML="指示剂",ready()}function getAliquot(){clearInterval(titreInterval),setAliquot(aliquot=document.getElementById("aliquot").value),document.getElementById("aliquotErr").innerHTML="试样体积",ready()}function getConcAcid(){clearInterval(titreInterval),concAcid=document.getElementById("concAcid").value,document.getElementById("concAcidErr").innerHTML=noErrFlag,ready()}function getConcBase(){clearInterval(titreInterval),concBase=document.getElementById("concBase").value,document.getElementById("concBaseErr").innerHTML=noErrFlag,ready()}function getTitrantA(){clearInterval(titreInterval),titrant="acid",document.getElementById("titrantA").checked=!0,document.getElementById("titrantB").checked=!1,document.getElementById("titrantErr").innerHTML=noErrFlag,ready()}function getTitrantB(){clearInterval(titreInterval),titrant="base",document.getElementById("titrantB").checked=!0,document.getElementById("titrantA").checked=!1,document.getElementById("titrantErr").innerHTML=noErrFlag,ready()}function getDropRate(){dropRate=Math.pow(10,4-(dropRate=document.getElementById("dropRate").value)),clearInterval(titreInterval),titreInterval=setInterval(titrationPlot,dropRate)}function setNormalMode(){document.getElementById("normal").checked=!0,document.getElementById("cheating").checked=!1,document.getElementById("graph_div").style.visibility="hidden",document.getElementById("results").style.visibility="hidden"}function setCheatingMode(){document.getElementById("cheating").checked=!0,document.getElementById("normal").checked=!1,document.getElementById("graph_div").style.visibility="visible",document.getElementById("results").style.visibility="visible"}function clearGraph(){graphFrame(),graphCTX.fillStyle="#ffffff",graphCTX.fillRect(51,42,299,7)}function reFill(){tapOpen=!1,eqPtFound=!1,document.getElementById("startButton").disabled=!0,level=0,titre=0,graphFrame(),graphCTX.fillStyle="#ffffff",graphCTX.fillRect(51,42,299,7),reading=((startLevel=84+20*Math.random())+level-84)/15,titreAtEqPt=titre="acid"==titrant?pipet*concBase/concAcid:pipet*concAcid/concBase,getpH(),pHAtEqPt=pH,titre=0,buretReading=reading.toFixed(2).toString(),document.getElementById("buretReading").innerHTML="<b>滴定管读数</b><br>"+buretReading+" mL",getpH(),pHReading=pH.toFixed(2).toString(),document.getElementById("pHReading").innerHTML="<b>pH 值</b><br>"+pHReading,document.getElementById("score").innerHTML="",showLiquids(level),clearInterval(stirInterval),stirInterval=setInterval(stirrer,50),clearInterval(titreInterval),titreInterval=setInterval(titrationPlot,dropRate)}function getpH(){strongAcid&strongBase&&strongAcidStrongBase(),!strongAcid&strongBase&&weakAcidStrongBase(),!strongBase&strongAcid&&strongAcidWeakBase(),!strongAcid&!strongBase&&(weakAcidWeakBase(),tapOpen=!1,showLiquids(level),clearInterval(titreInterval))}function ready(){return liquidsAdded=!1,"Choose"==acid&&(document.getElementById("acidErr").innerHTML="酸"+errFlag),"Choose"==base&&(document.getElementById("baseErr").innerHTML="碱"+errFlag),"Choose"==indicator&&(document.getElementById("indErr").innerHTML="指示剂"+errFlag),void 0==concAcid&&(document.getElementById("concAcidErr").innerHTML=errFlag),void 0==concBase&&(document.getElementById("concBaseErr").innerHTML=errFlag),void 0==titrant&&(document.getElementById("titrantErr").innerHTML=errFlag),"Choose"==aliquot&&(document.getElementById("aliquotErr").innerHTML="试样体积"+errFlag),"Choose"!=acid&&"Choose"!=base&&"Choose"!=indicator&&"Choose"!=aliquot&&void 0!=concAcid&&void 0!=concBase&&void 0!=titrant&&void 0!=Ka&&void 0!=Kb&&(document.getElementById("warnings").innerHTML="",document.getElementById("startButton").disabled=!1,!0)}function titrationPlot(){if(tapOpen){if(colourDpt=!1,showLiquids(level),buretReading=(reading=(startLevel+level-84)/15).toFixed(2).toString(),pHReading=pH.toFixed(2).toString(),document.getElementById("buretReading").innerHTML="<b>滴定管读数</b><br>"+buretReading+" mL",level+=.4,reading>=25){clearInterval(titreInterval),tapOpen=!1,showLiquids(level),document.getElementById("startButton").disabled=!1;return}prevpH=pH,prevTitre=titre,titre=level/15,getpH(),document.getElementById("pHReading").innerHTML="<b>pH 值</b><br>"+pHReading,graphCTX.lineWidth=2,level>1&&(graphCTX.beginPath(),graphCTX.strokeStyle="#ff0000",graphCTX.moveTo(50+12*prevTitre,351-300*prevpH/14),graphCTX.lineTo(50+12*titre,351-300*pH/14),graphCTX.stroke(),graphCTX.closePath()),level>1&&(graphCTX.beginPath(),graphCTX.strokeStyle=getColour(1),graphCTX.moveTo(50+12*titre,42),graphCTX.lineTo(50+12*titre,49),graphCTX.stroke(),graphCTX.closePath())}}function drawEqPt(e){e&&!eqPtFound&&(graphCTX.beginPath(),graphCTX.lineWidth=1,graphCTX.strokeStyle="#0000ff",graphCTX.moveTo(50+12*titreAtEqPt,51),graphCTX.lineTo(50+12*titreAtEqPt,351-300*pHAtEqPt/14),graphCTX.stroke(),graphCTX.closePath(),graphCTX.fillStyle="#ffffff",graphCTX.fillRect(28+12*titreAtEqPt,69,40,16),graphCTX.fillStyle="#0000ff",graphCTX.font="12px Times",graphCTX.fillText("Eq. Pt.",33+12*titreAtEqPt,81),graphCTX.lineWidth=2,graphCTX.strokeStyle="#ff0000",eqPtFound=!0,colourDpt=!0)}function titrate(){liquidsAdded&&(tapOpen?(tapOpen=!1,clearInterval(titreInterval),showLiquids(level),document.getElementById("startButton").disabled=!1):(tapOpen=!0,showLiquids(level),clearInterval(titreInterval),titreInterval=setInterval(titrationPlot,dropRate),document.getElementById("startButton").disabled=!0))}function titrateStart(e){var t,i,t=e.clientX-document.getElementById("buret").getBoundingClientRect().left;if(i=e.clientY-document.getElementById("buret").getBoundingClientRect().top,t>75&&t<90&&i>465&&i<485){if(!liquidsAdded)return;tapOpen||(tapOpen=!0,showLiquids(level),clearInterval(titreInterval),titreInterval=setInterval(titrationPlot,dropRate),document.getElementById("startButton").disabled=!0)}}function titrateStop(e){var t,i,t=e.clientX-document.getElementById("buret").getBoundingClientRect().left;if(i=e.clientY-document.getElementById("buret").getBoundingClientRect().top,t>75&&t<90&&i>465&&i<485){if(!liquidsAdded)return;tapOpen&&(tapOpen=!1,clearInterval(titreInterval),showLiquids(level),document.getElementById("startButton").disabled=!1)}}function graphAxes(){graphFrame(),graphLabels()}function graphFrame(){graphCTX.beginPath(),graphCTX.fillStyle="#ffffff",graphCTX.fillRect(45,40,307,316),graphCTX.strokeStyle="#000000",graphCTX.lineWidth=1,graphCTX.strokeRect(50,41,301,9),graphCTX.strokeRect(50,50,301,301),graphCTX.moveTo(45,50),graphCTX.lineTo(50,50),graphCTX.moveTo(45,201),graphCTX.lineTo(50,201),graphCTX.moveTo(45,351),graphCTX.lineTo(50,351),graphCTX.moveTo(50,351),graphCTX.lineTo(50,356),graphCTX.moveTo(111,351),graphCTX.lineTo(111,356),graphCTX.moveTo(171,351),graphCTX.lineTo(171,356),graphCTX.moveTo(231,351),graphCTX.lineTo(231,356),graphCTX.moveTo(291,351),graphCTX.lineTo(291,356),graphCTX.moveTo(351,351),graphCTX.lineTo(351,356),graphCTX.stroke()}function graphLabels(){graphCTX.font="16px Times New Roman",graphCTX.fillStyle="#006000",graphCTX.fillText("Titre (volume added, mL)",100,385),graphCTX.fillText("0",47,370),graphCTX.fillText("25",345,370),graphCTX.fillText("14",27,55),graphCTX.fillText("7",35,206),graphCTX.fillText("0",35,356),graphCTX.fillText("pH",26,150),graphCTX.beginPath(),graphCTX.strokeStyle="#006000",graphCTX.moveTo(275,380),graphCTX.lineTo(295,380),graphCTX.moveTo(290,377),graphCTX.lineTo(295,380),graphCTX.moveTo(290,383),graphCTX.lineTo(295,380),graphCTX.moveTo(35,90),graphCTX.lineTo(35,110),graphCTX.moveTo(35,90),graphCTX.lineTo(32,95),graphCTX.moveTo(35,90),graphCTX.lineTo(38,95),graphCTX.stroke()}function stirrer(){switch(stirBarCTX.clearRect(47,54,16,9),stirBarCTX.lineWidth=3,stirBarCTX.lineCap="round",stirBarCTX.strokeStyle="#808080",stirCount){case 0:stirBarCTX.beginPath(),stirBarCTX.moveTo(49,58),stirBarCTX.lineTo(61,58),stirBarCTX.stroke();break;case 1:stirBarCTX.beginPath(),stirBarCTX.moveTo(50,59),stirBarCTX.lineTo(60,57),stirBarCTX.stroke();break;case 2:stirBarCTX.beginPath(),stirBarCTX.moveTo(53,60),stirBarCTX.lineTo(59,56),stirBarCTX.stroke();break;case 3:stirBarCTX.beginPath(),stirBarCTX.moveTo(55,60),stirBarCTX.lineTo(55,55),stirBarCTX.stroke();break;case 4:stirBarCTX.beginPath(),stirBarCTX.moveTo(53,56),stirBarCTX.lineTo(59,60),stirBarCTX.stroke();break;case 5:stirBarCTX.beginPath(),stirBarCTX.moveTo(50,57),stirBarCTX.lineTo(60,59),stirBarCTX.stroke()}6==++stirCount&&(stirCount=0)}function showLiquids(e){var t=e/900+.3;switch(liquidsAdded=!0,liquidsCTX.fillStyle="#ffffff",liquidsCTX.fillRect(0,0,120,690),liquidsCTX.fillStyle="#f0f0f0",liquidsCTX.fillRect(10,startLevel+e-1,100,540-startLevel-e-1),liquidsCTX.strokeStyle="#000000",liquidsCTX.beginPath(),liquidsCTX.arc(57,startLevel+e-9,10,.27*Math.PI,.73*Math.PI),liquidsCTX.stroke(),liquidsCTX.fillStyle=getColour(1),aliquot){case"10 mL":liquidsCTX.fillRect(20,635-45*t,80,45*t+10),liquidsCTX.fillStyle=getColour(.9),liquidsCTX.beginPath(),liquidsCTX.moveTo(22+15*t,635-45*t),liquidsCTX.bezierCurveTo(22+15*t,630-45*t,92-15*t,630-45*t,92-15*t,635-45*t),liquidsCTX.bezierCurveTo(92-15*t,640-45*t,22+15*t,640-45*t,22+15*t,635-45*t);break;case"20 mL":liquidsCTX.fillRect(20,631-45*t,80,45*t+10),liquidsCTX.fillStyle=getColour(.9),liquidsCTX.beginPath(),liquidsCTX.moveTo(24+15*t,631-45*t),liquidsCTX.bezierCurveTo(24+15*t,626-45*t,90-15*t,626-45*t,90-15*t,631-45*t),liquidsCTX.bezierCurveTo(90-15*t,636-45*t,24+15*t,636-45*t,24+15*t,631-45*t);break;case"25 mL":liquidsCTX.fillRect(20,630-45*t,80,45*t+10),liquidsCTX.fillStyle=getColour(.9),liquidsCTX.beginPath(),liquidsCTX.moveTo(24+15*t,630-45*t),liquidsCTX.bezierCurveTo(24+15*t,625-45*t,90-15*t,625-45*t,90-15*t,630-45*t),liquidsCTX.bezierCurveTo(90-15*t,635-45*t,24+15*t,635-45*t,24+15*t,630-45*t)}liquidsCTX.stroke(),liquidsCTX.fill(),liquidsCTX.strokeStyle="#000000",liquidsCTX.lineWidth=1,tapOpen&&(drip=Math.round(35*Math.random()),e%2==0?(liquidsCTX.beginPath(),liquidsCTX.moveTo(56,550+drip),liquidsCTX.lineTo(56,555+drip),liquidsCTX.stroke()):(liquidsCTX.beginPath(),liquidsCTX.moveTo(56,560+drip),liquidsCTX.lineTo(56,565+drip),liquidsCTX.stroke()))}function strongAcidStrongBase(){var e,t,i,r,n,a,l;"acid"==titrant?(e=titre/1e3,t=pipet/1e3):(e=pipet/1e3,t=titre/1e3),i=t+e,pH=(r=(e*concAcid-t*concBase)/i)>0?-Math.log((l=quadPlus(n=r,a=-Kw))+r)/Math.LN10:14+Math.log((l=quadPlus(n=-r,a=-Kw))-r)/Math.LN10}function weakAcidStrongBase(){var e,t,i,r,n,a,l=[],o=Ka,d=0,$=0,g=0;"acid"==titrant?(e=titre/1e3,t=pipet/1e3):(e=pipet/1e3,t=titre/1e3),i=e+t,r=(e*concAcid-t*concBase)/i,n=t*concBase/i,r>.002&&(a=!1,pH=-Math.log($=quadPlus(o=n+Ka,d=-(r*Ka)))/Math.LN10),r<=.002&r>=-.002&&(a=!0,pH=0!=(g=pickRoot(l=cubicPlus(-Ka,-(Kw+Ka*r),n*Kw+Ka*Kw,Kw*Kw)))?-Math.log(Kw/g)/Math.LN10:14+Math.log(Math.sqrt(n*Kw/Ka))/Math.LN10),r<-.002&&(a=!1,n=e*concAcid/i,pH=14+Math.log(($=quadPlus(o=-r,d=-Kw))-r)/Math.LN10)}function strongAcidWeakBase(){var e,t,i,r,n,a,l,o=[],d=Kb,$=0,g=0;"acid"==titrant?(t=titre/1e3,i=pipet/1e3):(t=pipet/1e3,i=titre/1e3),r=t+i,n=(i*concBase-t*concAcid)/r,a=t*concAcid/r,n>.002&&(e=!1,pH=14+Math.log(g=quadPlus(d=a+Kb,$=-(n*Kb)))/Math.LN10),n<=.002&n>=-.002&&(e=!0,pH=0!=(l=pickRoot(o=cubicPlus(-Kb,-(Kw+Kb*n),a*Kw+Kb*Kw,Kw*Kw)))?14+Math.log(Kw/l)/Math.LN10:-Math.log(Math.sqrt(a*Kw/Kb))/Math.LN10),n<-.002&&(e=!1,a=t*concAcid/r,pH=-Math.log((g=quadPlus(d=-n,$=-Kw))-n)/Math.LN10)}function weakAcidWeakBase(){document.getElementById("startButton").disabled=!0,document.getElementById("warnings").innerHTML='<a class="button button--outline-primary button--rounded">警告：弱酸弱碱不应互相滴定</a>'}function setAcidity(){var e;switch(document.getElementById("acidKa").disabled=!0,acid){case"Hydrochloric acid":Ka=0,strongAcid=!0;break;case"Acetic acid":Ka=18e-6,strongAcid=!1;break;case"Chlorous acid":Ka=.012,strongAcid=!1;break;case"Hypochlorous acid":Ka=35e-9,strongAcid=!1;break;case"Hydrocyanic acid":Ka=62e-11,strongAcid=!1;break;case"Custom":if(document.getElementById("acidKa").disabled=!1,"--"==(e=document.getElementById("acidKa").value))break;"inf"==e.toLowerCase()?(Ka=0,strongAcid=!0):(Ka=parseFloat(e),strongAcid=!1)}void 0!==Ka&&(document.getElementById("acidKaErr").innerHTML=noErrFlag,0==Ka?document.getElementById("acidKa").value="Inf":document.getElementById("acidKa").value=Ka.toExponential(1))}function setBasicity(){var e;switch(document.getElementById("baseKb").disabled=!0,base){case"Sodium hydroxide":Kb=0,strongBase=!0;break;case"Ammonia":Kb=18e-6,strongBase=!1;break;case"Methylamine":Kb=438e-6,strongBase=!1;break;case"Ethylamine":Kb=568e-6,strongBase=!1;break;case"Aniline":Kb=38e-11,strongBase=!1;break;case"Pyridine":Kb=17e-10,strongBase=!1;break;case"Custom":if(document.getElementById("baseKb").disabled=!1,"--"==(e=document.getElementById("baseKb").value))break;"inf"==e.toLowerCase()?(Kb=0,strongBase=!0):(Kb=parseFloat(e),strongBase=!1)}void 0!==Kb&&(document.getElementById("baseKbErr").innerHTML=noErrFlag,0==Kb?document.getElementById("baseKb").value="Inf":document.getElementById("baseKb").value=Kb.toExponential(1))}function setIndicator(){switch(indicator){case"Phenolphthalein":pHInd=9,indRed1=255,indGreen1=100,indBlue1=255,indRed2=255,indGreen2=255,indBlue2=255;break;case"Methyl orange":pHInd=3.8,indRed1=255,indGreen1=255,indBlue1=0,indRed2=255,indGreen2=51,indBlue2=0;break;case"Bromothymol blue":pHInd=7,indRed1=0,indGreen1=0,indBlue1=255,indRed2=255,indGreen2=255,indBlue2=0;break;case"Crystal violet":pHInd=1,indRed1=99,indGreen1=0,indBlue1=217,indRed2=84,indGreen2=255,indBlue2=0;break;case"Alizarin yellow":pHInd=11,indRed1=255,indGreen1=77,indBlue1=0,indRed2=255,indGreen2=255,indBlue2=0;break;case"Erichrome black T":pHInd=5.8,indRed1=99,indGreen1=0,indBlue1=199,indRed2=255,indGreen2=0,indBlue2=0}}function setAliquot(){switch(aliquot){case"10 mL":pipet=10;break;case"20 mL":pipet=20;break;case"25 mL":pipet=25}}function getColour(e){var t;return(t=void 0==pH?0:pHInd-pH)>=1?colourCoder(indRed2,indGreen2,indBlue2,e):t<1&t>=-1?colourCoder(indRed1-(indRed1-indRed2)*(t+1)/2,indGreen1-(indGreen1-indGreen2)*(t+1)/2,indBlue1-(indBlue1-indBlue2)*(t+1)/2,e):t<-1?colourCoder(indRed1,indGreen1,indBlue1,e):void 0}function colourCoder(e,t,i,r){return"#"+(16777216+Math.round(i*r)+256*Math.round(t*r)+65536*Math.round(e*r)).toString(16).substr(1)}function quadPlus(e,t){var i=(-e+Math.sqrt(e*e-4*t))/2,r=(-e-Math.sqrt(e*e-4*t))/2;return i>=0?i:r>=0?r:0}function cubicPlus(e,t,i,r){var n,a,l,o,d,$,g,c,u,T,p,_,C,B,h=[];return(n=(3*i/e-t*t/(e*e))/3,(l=(a=(2*t*t*t/(e*e*e)-9*t*i/(e*e)+27*r/e)/27)*a/4+n*n*n/27)>0&&(_=signum(p=-(a/2)+Math.sqrt(l))*Math.pow(Math.abs(p),1/3),B=signum(C=-(a/2)-Math.sqrt(l))*Math.pow(Math.abs(C),1/3),h[0]=_+B-t/(3*e),h[3]=0,h[1]=-(_+B)/2-t/(3*e),h[4]=+((_-B)*Math.sqrt(3))/2,h[2]=-(_+B)/2-t/(3*e),h[5]=-((_-B)*Math.sqrt(3))/2),l<=0)?(d=signum(o=Math.sqrt(a*a/4-l))*Math.pow(Math.abs(o),1/3),$=Math.acos(-a/(2*o)),g=-d,c=Math.cos($/3),u=Math.sqrt(3)*Math.sin($/3),T=-t/(3*e),h[0]=2*d*Math.cos($/3)-t/(3*e),h[3]=0,h[1]=g*(c+u)+T,h[4]=0,h[2]=g*(c-u)+T,h[5]=0,h):(0==n&&0==a&&0==l&&(h[0]=h[1]=h[2]=-signum(r/e)*Math.pow(Math.abs(r/e),1/3),h[3]=h[4]=h[5]=0),h)}function pickRoot(e){var t=0;if(0!=e[4])return t=e[0],0;if(level>0)for(var i=0;i<3;i++)e[i]>t&&(t=e[i]);return t}function score(){if(!(isNaN(titre)||isNaN(titreAtEqPt))){tapOpen&&(tapOpen=!1,clearInterval(titreInterval),showLiquids(level),document.getElementById("startButton").disabled=!1);var e=titre-titreAtEqPt,t=e/titreAtEqPt*100;e=e.toFixed(2).toString(),t=t.toFixed(2).toString(),e>0?document.getElementById("score").innerHTML='<a class="button button--outline-primary button--rounded">滴定过量了'+e+" ml,相对偏差"+t+"%</a>":(e=-e,document.getElementById("score").innerHTML='<a class="button button--outline-primary button--rounded">距等当点还差'+e+" ml,相对偏差"+t+"%</a>")}}function signum(e){var t;return e>0&&(t=1),0==e&&(t=0),e<0&&(t=-1),t}window.onload=function(){(stirBarCTX=(stirBar=document.getElementById("stirBar")).getContext("2d")).fillStyle="#ffffff",stirBarCTX.lineWidth=2,stirBarCTX.strokeStyle="#000000",liquidsCTX=(liquids=document.getElementById("liquids")).getContext("2d"),graphCTX=(graph=document.getElementById("graph")).getContext("2d"),graphAxes(),stirCount=0,counter2=100,stirBarCTX.beginPath(),stirBarCTX.moveTo(50,57),stirBarCTX.lineTo(60,59),stirBarCTX.stroke(),clearInterval(stirInterval=setInterval(stirrer,50)),ready(),document.getElementById("warnings").innerHTML='<a class="button button--outline-primary button--rounded">警告：部分参数未设置</a>';var e=document.getElementById("refwidth").clientWidth/document.getElementById("graph_div").clientWidth;e>1&&(e=1),document.getElementById("graph_div").style.transform="scale("+e+")",document.getElementById("apparatus_area").style.transform="scale("+e+")",document.getElementById("titrate_area").style.height=document.getElementById("liquids").clientHeight*e+"px"},window.onresize=function(){var e=document.getElementById("refwidth").clientWidth/document.getElementById("graph_div").clientWidth;e>1&&(e=1),document.getElementById("graph_div").style.transform="scale("+e+")",document.getElementById("apparatus_area").style.transform="scale("+e+")",document.getElementById("titrate_area").style.height=document.getElementById("liquids").clientHeight*e+"px"};