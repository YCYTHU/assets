"use strict";var LOAD_FACTOR=.9,INITIAL_SIZE=16,HASHMAP_LIMIT=24,MASK_LEFT=1,MASK_TOP=2,MASK_RIGHT=4,MASK_BOTTOM=8;function LifeUniverse(){this.last_id=0,this.hashmap_size=0,this.max_load=0,this.hashmap=[],this.empty_tree_cache=[],this.level2_cache=[],this._powers=new Float64Array(1024),this._powers[0]=1;for(var e=1;e<1024;e++)this._powers[e]=2*this._powers[e-1];this._bitcounts=new Int8Array(1880),this._bitcounts.set([0,1,1,2,1,2,2,3,1,2,2,3,2,3,3,4]);for(var e=16;e<1880;e++)this._bitcounts[e]=this._bitcounts[15&e]+this._bitcounts[e>>4&15]+this._bitcounts[e>>8];this.rule_b=8,this.rule_s=12,this.root=null,this.rewind_state=null,this.step=0,this.generation=0,this.false_leaf={id:3,population:0,level:0},this.true_leaf={id:2,population:1,level:0},this.clear_pattern()}LifeUniverse.prototype.pow2=function(e){return e>=1024?1/0:this._powers[e]},LifeUniverse.prototype.save_rewind_state=function(){this.rewind_state=this.root},LifeUniverse.prototype.restore_rewind_state=function(){this.generation=0,this.root=this.rewind_state,this.garbage_collect()},LifeUniverse.prototype.eval_mask=function(e){return(32&e?this.rule_s:this.rule_b)>>this._bitcounts[1879&e]&1},LifeUniverse.prototype.level1_create=function(e){return this.create_tree(1&e?this.true_leaf:this.false_leaf,2&e?this.true_leaf:this.false_leaf,4&e?this.true_leaf:this.false_leaf,8&e?this.true_leaf:this.false_leaf)},LifeUniverse.prototype.set_bit=function(e,t,i){var s=this.get_level_from_bounds({x:e,y:t});if(i)for(;s>this.root.level;)this.root=this.expand_universe(this.root);else if(s>this.root.level)return;this.root=this.node_set_bit(this.root,e,t,i)},LifeUniverse.prototype.get_bit=function(e,t){return!(this.get_level_from_bounds({x:e,y:t})>this.root.level)&&this.node_get_bit(this.root,e,t)},LifeUniverse.prototype.get_root_bounds=function(){if(0===this.root.population)return{top:0,left:0,bottom:0,right:0};var e={top:1/0,left:1/0,bottom:-1/0,right:-1/0},t=this.pow2(this.root.level-1);return this.node_get_boundary(this.root,-t,-t,MASK_TOP|MASK_LEFT|MASK_BOTTOM|MASK_RIGHT,e),e},LifeUniverse.prototype.empty_tree=function(e){var t;return this.empty_tree_cache[e]?this.empty_tree_cache[e]:(t=1===e?this.false_leaf:this.empty_tree(e-1),this.empty_tree_cache[e]=this.create_tree(t,t,t,t))},LifeUniverse.prototype.expand_universe=function(e){var t=this.empty_tree(e.level-1);return this.create_tree(this.create_tree(t,t,t,e.nw),this.create_tree(t,t,e.ne,t),this.create_tree(t,e.sw,t,t),this.create_tree(e.se,t,t,t))},LifeUniverse.prototype.uncache=function(e){for(var t=0;t<=this.hashmap_size;t++){var i=this.hashmap[t];void 0!==i&&(i.cache=null,i.hashmap_next=void 0,e&&(i.quick_cache=null))}},LifeUniverse.prototype.in_hashmap=function(e){for(var t=this.calc_hash(e.nw.id,e.ne.id,e.sw.id,e.se.id)&this.hashmap_size,i=this.hashmap[t];;){if(void 0===i)return!1;if(i===e)return!0;i=i.hashmap_next}},LifeUniverse.prototype.hashmap_insert=function(e){for(var t,i=this.calc_hash(e.nw.id,e.ne.id,e.sw.id,e.se.id)&this.hashmap_size,s=this.hashmap[i];;){if(void 0===s){void 0!==t?t.hashmap_next=e:this.hashmap[i]=e;return}t=s,s=s.hashmap_next}},LifeUniverse.prototype.create_tree=function(e,t,i,s){for(var n,r=this.calc_hash(e.id,t.id,i.id,s.id)&this.hashmap_size,o=this.hashmap[r];;){if(void 0===o){if(this.last_id>this.max_load)return this.garbage_collect(),this.create_tree(e,t,i,s);var h=new this.TreeNode(e,t,i,s,this.last_id++);return void 0!==n?n.hashmap_next=h:this.hashmap[r]=h,h}if(o.nw===e&&o.ne===t&&o.sw===i&&o.se===s)return o;n=o,o=o.hashmap_next}},LifeUniverse.prototype.next_generation=function(e){for(var t=this.root;e&&t.level<=this.step+2||t.nw.population!==t.nw.se.se.population||t.ne.population!==t.ne.sw.sw.population||t.sw.population!==t.sw.ne.ne.population||t.se.population!==t.se.nw.nw.population;)t=this.expand_universe(t);e?(this.generation+=this.pow2(this.step),t=this.node_next_generation(t)):(this.generation+=this.pow2(this.root.level-2),t=this.node_quick_next_generation(t)),this.root=t},LifeUniverse.prototype.garbage_collect=function(){this.hashmap_size<(1<<HASHMAP_LIMIT)-1&&(this.hashmap_size=this.hashmap_size<<1|1,this.hashmap=[]),this.max_load=this.hashmap_size*LOAD_FACTOR|0;for(var e=0;e<=this.hashmap_size;e++)this.hashmap[e]=void 0;this.last_id=4,this.node_hash(this.root)},LifeUniverse.prototype.calc_hash=function(e,t,i,s){return((23*e^t)*23^i)*23^s},LifeUniverse.prototype.clear_pattern=function(){this.last_id=4,this.hashmap_size=(1<<INITIAL_SIZE)-1,this.max_load=this.hashmap_size*LOAD_FACTOR|0,this.hashmap=[],this.empty_tree_cache=[],this.level2_cache=Array(65536);for(var e=0;e<=this.hashmap_size;e++)this.hashmap[e]=void 0;this.root=this.empty_tree(3),this.generation=0},LifeUniverse.prototype.get_bounds=function(e,t){if(!e.length)return{top:0,left:0,bottom:0,right:0};for(var i={top:t[0],left:e[0],bottom:t[0],right:e[0]},s=e.length,n=1;n<s;n++){var r=e[n],o=t[n];r<i.left?i.left=r:r>i.right&&(i.right=r),o<i.top?i.top=o:o>i.bottom&&(i.bottom=o)}return i},LifeUniverse.prototype.get_level_from_bounds=function(e){for(var t=4,i=Object.keys(e),s=0;s<i.length;s++){var n=e[i[s]];n+1>t?t=n+1:-n>t&&(t=-n)}return Math.ceil(Math.log(t)/Math.LN2)+1},LifeUniverse.prototype.field2tree=function(e,t){var i=n(),s=e.length;function n(){return{nw:!1,ne:!1,sw:!1,se:!1}}for(var r=0;r<s;r++){for(var o=e[r].x,h=e[r].y,a=i,p=t-2;p>=0;p--){var l=this.pow2(p);o<0?(o+=l,h<0?(h+=l,a.nw||(a.nw=n()),a=a.nw):(h-=l,a.sw||(a.sw=n()),a=a.sw)):(o-=l,h<0?(h+=l,a.ne||(a.ne=n()),a=a.ne):(h-=l,a.se||(a.se=n()),a=a.se))}o<0?h<0?a.nw=!0:a.sw=!0:h<0?a.ne=!0:a.se=!0}return i},LifeUniverse.prototype.make_center=function(e,t,i){var s=Math.round((i.left-i.right)/2)-i.left,n=Math.round((i.top-i.bottom)/2)-i.top;this.move_field(e,t,s,n),i.left+=s,i.right+=s,i.top+=n,i.bottom+=n},LifeUniverse.prototype.move_field=function(e,t,i,s){for(var n=e.length,r=0;r<n;r++)e[r]+=i,t[r]+=s},LifeUniverse.prototype.setup_field=function(e,t,i){void 0===i&&(i=this.get_bounds(e,t));var s=this.get_level_from_bounds(i),n=this.pow2(s-1),r=e.length;this.move_field(e,t,n,n),this.root=this.setup_field_recurse(0,r-1,e,t,s)},LifeUniverse.prototype.partition=function(e,t,i,s,n){for(var r,o=e,h=t;o<=h;){for(;o<=t&&(i[o]&n)==0;)o++;for(;h>e&&i[h]&n;)h--;if(o>=h)break;r=i[o],i[o]=i[h],i[h]=r,r=s[o],s[o]=s[h],s[h]=r,o++,h--}return o},LifeUniverse.prototype.setup_field_recurse=function(e,t,i,s,n){if(e>t)return this.empty_tree(n);if(2===n)return this.level2_setup(e,t,i,s);var r=1<<--n,o=this.partition(e,t,s,i,r),h=this.partition(e,o-1,i,s,r),a=this.partition(o,t,i,s,r);return this.create_tree(this.setup_field_recurse(e,h-1,i,s,n),this.setup_field_recurse(h,o-1,i,s,n),this.setup_field_recurse(o,a-1,i,s,n),this.setup_field_recurse(a,t,i,s,n))},LifeUniverse.prototype.level2_setup=function(e,t,i,s){for(var n,r,o=0,h=e;h<=t;h++)o|=1<<(1&(n=i[h])|(1&(r=s[h])|2&n)<<1|(2&r)<<2);return this.level2_cache[o]?this.level2_cache[o]:this.level2_cache[o]=this.create_tree(this.level1_create(o),this.level1_create(o>>4),this.level1_create(o>>8),this.level1_create(o>>12))},LifeUniverse.prototype.setup_meta=function(e,t,i,s){var n=this.get_level_from_bounds(s),r=this.field2tree(i,n);this.root=function i(s,n){if(11===n)return s?e:t;if(s)return n--,this.create_tree(i(s.nw,n),i(s.ne,n),i(s.sw,n),i(s.se,n));var r=i(!1,n-1);return this.create_tree(r,r,r,r)}(r,n+11)},LifeUniverse.prototype.set_step=function(e){e!==this.step&&(this.step=e,this.uncache(!1),this.empty_tree_cache=[],this.level2_cache=Array(65536))},LifeUniverse.prototype.set_rules=function(e,t){(this.rule_s!==e||this.rule_b!==t)&&(this.rule_s=e,this.rule_b=t,this.uncache(!0),this.empty_tree_cache=[],this.level2_cache=Array(65536))},LifeUniverse.prototype.TreeNode=function(e,t,i,s,n){this.nw=e,this.ne=t,this.sw=i,this.se=s,this.id=n,this.level=e.level+1,this.population=e.population+t.population+i.population+s.population,this.cache=null,this.quick_cache=null,this.hashmap_next=void 0},LifeUniverse.prototype.node_set_bit=function(e,t,i,s){if(0===e.level)return s?this.true_leaf:this.false_leaf;var n=1===e.level?0:this.pow2(e.level-2),r=e.nw,o=e.ne,h=e.sw,a=e.se;return t<0?i<0?r=this.node_set_bit(r,t+n,i+n,s):h=this.node_set_bit(h,t+n,i-n,s):i<0?o=this.node_set_bit(o,t-n,i+n,s):a=this.node_set_bit(a,t-n,i-n,s),this.create_tree(r,o,h,a)},LifeUniverse.prototype.node_get_bit=function(e,t,i){if(0===e.population)return!1;if(0===e.level)return!0;var s=1===e.level?0:this.pow2(e.level-2);return t<0?i<0?this.node_get_bit(e.nw,t+s,i+s):this.node_get_bit(e.sw,t+s,i-s):i<0?this.node_get_bit(e.ne,t-s,i+s):this.node_get_bit(e.se,t-s,i-s)},LifeUniverse.prototype.node_get_field=function(e,t,i,s){if(0!==e.population){if(0===e.level)s.push({x:t,y:i});else{var n=this.pow2(e.level-1);this.node_get_field(e.nw,t,i,s),this.node_get_field(e.sw,t,i+n,s),this.node_get_field(e.ne,t+n,i,s),this.node_get_field(e.se,t+n,i+n,s)}}},LifeUniverse.prototype.node_level2_next=function(e){var t=e.nw,i=e.ne,s=e.sw,n=e.se,r=t.nw.population<<15|t.ne.population<<14|i.nw.population<<13|i.ne.population<<12|t.sw.population<<11|t.se.population<<10|i.sw.population<<9|i.se.population<<8|s.nw.population<<7|s.ne.population<<6|n.nw.population<<5|n.ne.population<<4|s.sw.population<<3|s.se.population<<2|n.sw.population<<1|n.se.population;return this.level1_create(this.eval_mask(r>>5)|this.eval_mask(r>>4)<<1|this.eval_mask(r>>1)<<2|this.eval_mask(r)<<3)},LifeUniverse.prototype.node_next_generation=function(e){if(e.cache)return e.cache;if(this.step===e.level-2)return this.node_quick_next_generation(e);if(2===e.level)return e.quick_cache?e.quick_cache:e.quick_cache=this.node_level2_next(e);var t=e.nw,i=e.ne,s=e.sw,n=e.se,r=this.create_tree(t.nw.se,t.ne.sw,t.sw.ne,t.se.nw),o=this.create_tree(t.ne.se,i.nw.sw,t.se.ne,i.sw.nw),h=this.create_tree(i.nw.se,i.ne.sw,i.sw.ne,i.se.nw),a=this.create_tree(t.sw.se,t.se.sw,s.nw.ne,s.ne.nw),p=this.create_tree(t.se.se,i.sw.sw,s.ne.ne,n.nw.nw),l=this.create_tree(i.sw.se,i.se.sw,n.nw.ne,n.ne.nw),u=this.create_tree(s.nw.se,s.ne.sw,s.sw.ne,s.se.nw),c=this.create_tree(s.ne.se,n.nw.sw,s.se.ne,n.sw.nw),f=this.create_tree(n.nw.se,n.ne.sw,n.sw.ne,n.se.nw);return e.cache=this.create_tree(this.node_next_generation(this.create_tree(r,o,a,p)),this.node_next_generation(this.create_tree(o,h,p,l)),this.node_next_generation(this.create_tree(a,p,u,c)),this.node_next_generation(this.create_tree(p,l,c,f)))},LifeUniverse.prototype.node_quick_next_generation=function(e){if(null!==e.quick_cache)return e.quick_cache;if(2===e.level)return e.quick_cache=this.node_level2_next(e);var t=e.nw,i=e.ne,s=e.sw,n=e.se,r=this.node_quick_next_generation(t),o=this.node_quick_next_generation(this.create_tree(t.ne,i.nw,t.se,i.sw)),h=this.node_quick_next_generation(i),a=this.node_quick_next_generation(this.create_tree(t.sw,t.se,s.nw,s.ne)),p=this.node_quick_next_generation(this.create_tree(t.se,i.sw,s.ne,n.nw)),l=this.node_quick_next_generation(this.create_tree(i.sw,i.se,n.nw,n.ne)),u=this.node_quick_next_generation(s),c=this.node_quick_next_generation(this.create_tree(s.ne,n.nw,s.se,n.sw)),f=this.node_quick_next_generation(n);return e.quick_cache=this.create_tree(this.node_quick_next_generation(this.create_tree(r,o,a,p)),this.node_quick_next_generation(this.create_tree(o,h,p,l)),this.node_quick_next_generation(this.create_tree(a,p,u,c)),this.node_quick_next_generation(this.create_tree(p,l,c,f)))},LifeUniverse.prototype.node_hash=function(e){this.in_hashmap(e)||(e.id=this.last_id++,e.hashmap_next=void 0,e.level>1&&(this.node_hash(e.nw),this.node_hash(e.ne),this.node_hash(e.sw),this.node_hash(e.se),e.cache&&this.node_hash(e.cache),e.quick_cache&&this.node_hash(e.quick_cache)),this.hashmap_insert(e))},LifeUniverse.prototype.node_get_boundary=function(e,t,i,s,n){if(0!==e.population&&s){if(0===e.level)t<n.left&&(n.left=t),t>n.right&&(n.right=t),i<n.top&&(n.top=i),i>n.bottom&&(n.bottom=i);else{var r=this.pow2(e.level-1);if(t>=n.left&&t+2*r<=n.right&&i>=n.top&&i+2*r<=n.bottom)return;var o=s,h=s,a=s,p=s;e.nw.population&&(h&=~MASK_TOP,a&=~MASK_LEFT,p&=~MASK_TOP&~MASK_LEFT),e.sw.population&&(p&=~MASK_LEFT,o&=~MASK_BOTTOM,a&=~MASK_BOTTOM&~MASK_LEFT),e.ne.population&&(o&=~MASK_RIGHT,p&=~MASK_TOP,h&=~MASK_TOP&~MASK_RIGHT),e.se.population&&(h&=~MASK_RIGHT,a&=~MASK_BOTTOM,o&=~MASK_BOTTOM&~MASK_RIGHT),this.node_get_boundary(e.nw,t,i,o,n),this.node_get_boundary(e.sw,t,i+r,h,n),this.node_get_boundary(e.ne,t+r,i,a,n),this.node_get_boundary(e.se,t+r,i+r,p,n)}}};